#include "stdafx.h"

//#pragma once




//Logger Texture::log = Logger("Texture");

BobTexture *BobTexture::lastBoundTexture = nullptr;


//#ifdef ORBIS
//ArrayList<ssgi::TextureImpl*> BobTexture::texturesToDeleteAfterRender;
//#endif

//=========================================================================================================================
BobTexture *BobTexture::getLastBoundTexture()
{//=========================================================================================================================
	return lastBoundTexture;
}

//#ifndef ORBIS
//=========================================================================================================================
BobTexture::BobTexture(const string &cacheName, GLuint textureID)
{//=========================================================================================================================


	this->glTargetType = GL_TEXTURE_2D;
	this->cacheName = cacheName;
	this->textureID = textureID;
	lastBoundTexture = this;

}
BobTexture::~BobTexture()
{
	release();
}

//#else

//#endif


//=========================================================================================================================
bool BobTexture::hasAlpha()
{//=========================================================================================================================
	return alpha;
}



//=========================================================================================================================
void BobTexture::setAlpha(bool alpha)
{//=========================================================================================================================
	this->alpha = alpha;
}

//=========================================================================================================================
void BobTexture::bindNone()
{//=========================================================================================================================
	lastBoundTexture = nullptr;


	glDisable(GL_TEXTURE_2D);

}

//=========================================================================================================================
void BobTexture::unbind()
{//=========================================================================================================================

	lastBoundTexture = nullptr;
}

//=========================================================================================================================
void BobTexture::bind()
{//=========================================================================================================================

//#ifndef ORBIS
	if (lastBoundTexture != this)
	{
		lastBoundTexture = this;
		glEnable(GL_TEXTURE_2D);
		glBindTexture(glTargetType, textureID);
	}
//#else
//	if (lastBoundTexture != this)
//	{
//		lastBoundTexture = this;
//	}
//#endif
}

//=========================================================================================================================
void BobTexture::setImageHeight(int imageHeight)
{//=========================================================================================================================
	this->imageHeight = imageHeight;
	setHeightRatio();
}

//=========================================================================================================================
void BobTexture::setImageWidth(int imageWidth)
{//=========================================================================================================================
	this->imageWidth = imageWidth;
	setWidthRatio();
}

//=========================================================================================================================
int BobTexture::getImageHeight()
{//=========================================================================================================================
	return imageHeight;
}

//=========================================================================================================================
int BobTexture::getImageWidth()
{//=========================================================================================================================
	return imageWidth;
}

//=========================================================================================================================
float BobTexture::getHeightRatio()
{//=========================================================================================================================
	return heightRatio;
}

//=========================================================================================================================
float BobTexture::getWidthRatio()
{//=========================================================================================================================
	return widthRatio;
}

//=========================================================================================================================
int BobTexture::getTextureHeight()
{//=========================================================================================================================
	return texHeight;
}

//=========================================================================================================================
int BobTexture::getTextureWidth()
{//=========================================================================================================================
	return texWidth;
}

//=========================================================================================================================
void BobTexture::setTextureHeight(int texHeight)
{//=========================================================================================================================
	this->texHeight = texHeight;
	setHeightRatio();
}

//=========================================================================================================================
void BobTexture::setTextureWidth(int texWidth)
{//=========================================================================================================================
	this->texWidth = texWidth;
	setWidthRatio();
}

//=========================================================================================================================
void BobTexture::setHeightRatio()
{//=========================================================================================================================
	if (texHeight != 0)
	{
		heightRatio = (static_cast<float>(imageHeight)) / texHeight;
	}
}


//=========================================================================================================================
void BobTexture::setWidthRatio()
{//=========================================================================================================================
	if (texWidth != 0)
	{
		widthRatio = (static_cast<float>(imageWidth)) / texWidth;
	}
}

//=========================================================================================================================
void BobTexture::release()
{//=========================================================================================================================

	if(textureID == 0) return;

//#ifndef ORBIS
	GLuint *textureIDs = new GLuint[1];
	textureIDs[0] = textureID;

	glDeleteTextures(1, textureIDs);
	textureID = 0;

	delete[] textureIDs;


//#else
//
//	//Main::log.debug("BobTexture::release");
//
//	if(this->texture!=nullptr)
//	{
//
//
////		if(((ssgi::TextureImpl*)this->texture)->m_textureBuffer!=nullptr)
////		{
////			delete ((ssgi::TextureImpl*)this->texture)->m_textureBuffer;
////			((ssgi::TextureImpl*)this->texture)->m_textureBuffer = nullptr;
////		}
//
//		//this->texture->finalize();
//
//		//exit(0);
//
//		//Main::log.debug("delete this->texture");
//
//		//TODO: this leaks texture but not texture data, but if i delete texture it crashes ???
//		//delete this->texture;
//
//		texturesToDeleteAfterRender.add(this->texture);
//
//		//Main::log.debug("DONE this->texture = nullptr");
//
//		this->texture = nullptr;
//	}
//
//#endif
	if (lastBoundTexture == this)
	{
		bindNone();
	}

	if (cacheName != "")
	{
		string tempName = cacheName;
		cacheName = "";
		GLUtils::clearCache(tempName);
	}

	GLUtils::texturesLoaded--;
	GLUtils::textureBytesLoaded -= (getTextureWidth() * getTextureHeight() * 4);

	//Main::log.debug("DONE release");
}


//#ifndef ORBIS
//=========================================================================================================================
GLuint BobTexture::getTextureID()
{//=========================================================================================================================
	return textureID;
}

//=========================================================================================================================
void BobTexture::setTextureID(GLuint textureID)
{//=========================================================================================================================
	this->textureID = textureID;
}
//#else

//#endif



//=========================================================================================================================
sp<ByteArray> BobTexture::getTextureData()
{//=========================================================================================================================
	sp<ByteArray> buffer = ms<ByteArray>((hasAlpha() ? 4 : 3) * texWidth * texHeight);
	bind();

#ifndef ORBIS
	glGetTexImage(GL_TEXTURE_2D, 0, hasAlpha() ? GL_RGBA : GL_RGB, GL_UNSIGNED_BYTE, buffer->data());
#else

#endif

	return buffer;
}
